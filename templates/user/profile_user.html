{% extends 'base.html' %}
{% block conteudo %}

<div class="card-menu container">
  <h3 class="text-center">Lista de Perfis</h3>

  <div class="container mb-3 d-flex justify-content-center">
    <div class="d-flex">
      <form method="GET" action="{{ url_for('profile.list_profiles_route') }}" class="d-flex">
        <select name="field" class="form-select me-2" style="max-width: 150px;">
          <option value="name" {% if campo == 'name' %}selected{% endif %}>Nome</option>
        </select>
        <input type="text" name="search" class="form-control me-2" placeholder="Pesquisa" value="{{ busca }}">
        <button type="submit" class="btn btn-primary">Buscar</button>
      </form>
    </div>
  </div>

  <div class="container text-center">
    <button type="button" class="btn btn-primary mb-2" data-bs-toggle="modal" data-bs-target="#modalCadastroPerfil">
      Cadastrar perfil
    </button>
    <button id="btnEditarPerfil" type="button" class="btn btn-secondary mb-2" data-bs-toggle="modal" data-bs-target="#modalEdicaoPerfil" disabled>
      Editar
    </button>
    <button id="btnExcluirPerfil" type="button" class="btn btn-danger mb-2" disabled>
      Excluir
    </button>
  </div>

  <div class="d-flex justify-content-end mb-2" style="padding: 0 15px;">
    <a href="{{ url_for('profile.export_profiles_excel', search=busca, field=campo) }}" class="btn btn-success">
      Exportar Excel
    </a>
  </div>

  <table class="table table-striped table-hover table-compact" id="tabelaPerfis">
    <thead>
      <tr>
        <th>ID</th>
        <th>Nome</th>
      </tr>
    </thead>
    <tbody>
      {% for perfil in perfis %}
      <tr data-id="{{ perfil.id }}" data-name="{{ perfil.name }}">
        <td>{{ perfil.id }}</td>
        <td>{{ perfil.name }}</td>
      </tr>
      {% endfor %}
    </tbody>
  </table>

  <div class="container d-flex justify-content-center mt-3">
    <nav aria-label="Paginação">
      <ul class="pagination">
        {% if pagina > 1 %}
        <li class="page-item">
          <a class="page-link" href="?page={{ pagina - 1 }}&search={{ busca }}&field={{ campo }}">Anterior</a>
        </li>
        {% endif %}
        {% for p in range(1, total_paginas+1) %}
        <li class="page-item {% if p == pagina %}active{% endif %}">
          <a class="page-link" href="?page={{ p }}&search={{ busca }}&field={{ campo }}">{{ p }}</a>
        </li>
        {% endfor %}
        {% if pagina < total_paginas %}
        <li class="page-item">
          <a class="page-link" href="?page={{ pagina + 1 }}&search={{ busca }}&field={{ campo }}">Próximo</a>
        </li>
        {% endif %}
      </ul>
    </nav>
  </div>
</div>

<div class="modal fade" id="modalEdicaoPerfil" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form action="" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Alteração de cadastro de perfil</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" name="id" id="edicaoPerfilId">
          <div class="mb-3">
            <label for="edicaoPerfilNome">Nome</label>
            <input type="text" class="form-control" id="edicaoPerfilNome" name="nome">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Salvar</button>
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<div class="modal fade" id="modalCadastroPerfil" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <form action="{{ url_for('profile.register_profile') }}" method="POST">
        <div class="modal-header">
          <h5 class="modal-title">Cadastro de Perfil</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="cadastroPerfilNome">Nome</label>
            <input type="text" class="form-control" id="cadastroPerfilNome" name="nome" placeholder="Nome">
          </div>
        </div>
        <div class="modal-footer">
          <button type="submit" class="btn btn-primary">Cadastrar</button>
          <button type="button" class="btn btn-danger" data-bs-dismiss="modal">Cancelar</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
  const tabelaPerfis = document.querySelector('#tabelaPerfis tbody')
  const botaoEditarPerfil = document.getElementById('btnEditarPerfil')
  const botaoExcluirPerfil = document.getElementById('btnExcluirPerfil')
  let linhaPerfilSelecionada = null

  tabelaPerfis.addEventListener('click', e => {
    const linha = e.target.closest('tr')
    if (!linha) return
    if (linhaPerfilSelecionada !== linha) {
      if (linhaPerfilSelecionada) linhaPerfilSelecionada.classList.remove('table-active')
      linhaPerfilSelecionada = linha
      linhaPerfilSelecionada.classList.add('table-active')
    } else {
      linhaPerfilSelecionada.classList.remove('table-active')
      linhaPerfilSelecionada = null
    }
    botaoEditarPerfil.disabled = !linhaPerfilSelecionada
    botaoExcluirPerfil.disabled = !linhaPerfilSelecionada
  })

  botaoEditarPerfil.addEventListener('click', () => {
  if (!linhaPerfilSelecionada) return
  const idPerfil = linhaPerfilSelecionada.getAttribute('data-id')
  const nomePerfil = linhaPerfilSelecionada.getAttribute('data-name')
  const formularioEdicao = document.querySelector('#modalEdicaoPerfil form')
  formularioEdicao.action = `/profile/${idPerfil}/update`
  document.getElementById('edicaoPerfilId').value = idPerfil
  document.getElementById('edicaoPerfilNome').value = nomePerfil
  })

  botaoExcluirPerfil.addEventListener('click', () => {
    if (!linhaPerfilSelecionada) return
    const idPerfil = linhaPerfilSelecionada.getAttribute('data-id')
    if (confirm('Deseja excluir este registro?')) {
      window.location.href = `/profile/${idPerfil}/remove`
    }
  })
</script>

{% endblock conteudo %}
